name: Build CLI - macOS

on:
  workflow_dispatch:
    inputs:
      php_version:
        description: 'PHP version to build'
        required: true
        type: choice
        options:
          - '8.3'
          - '8.4'
          - '8.5'
          - 'all'
        default: '8.4'
      architecture:
        description: 'macOS architecture'
        required: true
        type: choice
        options:
          - 'arm64'
          - 'x86_64'
          - 'both'
        default: 'arm64'
      upload_artifact:
        description: 'Upload binary as artifact'
        required: false
        type: boolean
        default: true
  push:
    branches:
      - main
    paths:
      - 'configs/cli/**'
      - 'configs/extensions/**'
      - 'scripts/build-cli.sh'
      - '.github/workflows/build-cli-mac.yml'
  pull_request:
    paths:
      - 'configs/cli/**'
      - 'configs/extensions/**'
      - 'scripts/build-cli.sh'
      - '.github/workflows/build-cli-mac.yml'

jobs:
  build:
    name: PHP ${{ matrix.php }} - ${{ matrix.arch }}
    runs-on: ${{ matrix.runner }}

    strategy:
      fail-fast: false
      matrix:
        include:
          - php: '8.4'
            arch: arm64
            runner: macos-14

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Homebrew
        run: |
          echo "Homebrew setup"
          if [ "${{ matrix.arch }}" = "arm64" ]; then
            echo "HOMEBREW_PREFIX=/opt/homebrew" >> $GITHUB_ENV
          else
            echo "HOMEBREW_PREFIX=/usr/local" >> $GITHUB_ENV
          fi

      - name: Install dependencies
        run: |
          # Update Homebrew
          brew update

          # Install dependencies
          brew install \
            shivammathur/php/php@${{ matrix.php }}-zts \
            pkg-config \
            composer \
            autoconf \
            automake \
            libtool \
            bison \
            re2c

          # Link PHP
          brew link --overwrite --force shivammathur/php/php@${{ matrix.php }}-zts || true

      - name: Verify installation
        run: |
          echo "PHP version:"
          php --version || echo "PHP not in PATH"

          echo ""
          echo "Composer version:"
          composer --version

          echo ""
          echo "Environment:"
          echo "  HOMEBREW_PREFIX=$HOMEBREW_PREFIX"
          echo "  PATH=$PATH"

      - name: Clone static-php-cli
        run: |
          git clone --depth 1 https://github.com/crazywhalecc/static-php-cli.git
          cd static-php-cli
          composer install --no-dev --optimize-autoloader

      - name: Configure build
        run: |
          cd static-php-cli
          cp ../configs/cli/craft-${{ matrix.php }}.yml ./craft.yml

          echo "Configuration:"
          cat craft.yml

      - name: Run SPC doctor
        run: |
          cd static-php-cli
          php bin/spc doctor --auto-fix || true

      - name: Download sources
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cd static-php-cli
          # Extract extensions from craft.yml (between "extensions:" and "libs:" sections)
          EXTENSIONS=$(awk '/^extensions:/,/^libs:/ {if ($0 ~ /^  - /) print $2}' craft.yml | tr '\n' ',' | sed 's/,$//')
          echo "Downloading sources for extensions: $EXTENSIONS"
          php bin/spc download --with-php=${{ matrix.php }} --for-extensions=$EXTENSIONS

      - name: Build PHP CLI
        run: |
          cd static-php-cli
          # Extract extensions from craft.yml
          EXTENSIONS=$(awk '/^extensions:/,/^libs:/ {if ($0 ~ /^  - /) print $2}' craft.yml | tr '\n' ',' | sed 's/,$//')
          echo "Building PHP CLI with extensions: $EXTENSIONS"
          php bin/spc build --build-cli $EXTENSIONS

      - name: Test binary
        run: |
          cd static-php-cli

          echo "Testing binary..."
          ./buildroot/bin/php -v

          echo ""
          echo "Loaded extensions:"
          ./buildroot/bin/php -m

          echo ""
          echo "Extension count:"
          ./buildroot/bin/php -r 'echo count(get_loaded_extensions()) . " extensions loaded\n";'

          echo ""
          echo "MongoDB test:"
          ./buildroot/bin/php -r 'echo "MongoDB: " . (extension_loaded("mongodb") ? "OK" : "MISSING") . "\n";'

      - name: Prepare artifact
        run: |
          cd static-php-cli
          BINARY_NAME="php-cli-${{ matrix.php }}-darwin-${{ matrix.arch }}"
          cp ./buildroot/bin/php "../${BINARY_NAME}"
          chmod +x "../${BINARY_NAME}"

          cd ..
          echo "Binary size: $(du -h ${BINARY_NAME} | cut -f1)"

          # Create checksum
          shasum -a 256 "${BINARY_NAME}" > "${BINARY_NAME}.sha256"

          echo "BINARY_NAME=${BINARY_NAME}" >> $GITHUB_ENV

      - name: Upload artifact
        if: ${{ github.event.inputs.upload_artifact != 'false' }}
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.BINARY_NAME }}
          path: |
            ${{ env.BINARY_NAME }}
            ${{ env.BINARY_NAME }}.sha256
          retention-days: 30

      - name: Upload to release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            ${{ env.BINARY_NAME }}
            ${{ env.BINARY_NAME }}.sha256
